{% extends "base.html" %}
{% block title %}Pulse â€” Investment Thesis{% endblock %}

{% block content %}
<div class="sb-brief-header">
  <h1 class="sb-brief-header__date">Investment Thesis</h1>
  <div class="sb-brief-header__meta">
    <span>{{ today_date.strftime('%B %d, %Y') }}</span>
  </div>
</div>

{% if thesis_section and thesis_section.get('content') %}
  {% set thesis = thesis_section.content %}
  {% include "partials/thesis_card.html" %}

  <!-- Extended detail if thesis model is available -->
  {% if thesis_model %}
  <div style="margin-top:var(--sb-space-6);">
    <div class="sb-weather">
      <div class="sb-weather__title">Signal Detail</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sb-space-4);margin-top:var(--sb-space-3);">
        <div>
          <div style="font-size:var(--sb-text-xs);color:var(--sb-text-muted);margin-bottom:var(--sb-space-1);">Momentum Signal</div>
          {% if thesis_model.momentum_signal %}
          <pre style="font-family:var(--sb-font-mono);font-size:var(--sb-text-xs);color:var(--sb-text-secondary);margin:0;white-space:pre-wrap;">{{ thesis_model.momentum_signal | tojson(indent=2) }}</pre>
          {% else %}
          <span style="color:var(--sb-text-muted);font-size:var(--sb-text-sm);">Not available</span>
          {% endif %}
        </div>
        <div>
          <div style="font-size:var(--sb-text-xs);color:var(--sb-text-muted);margin-bottom:var(--sb-space-1);">Value Signal</div>
          {% if thesis_model.value_signal %}
          <pre style="font-family:var(--sb-font-mono);font-size:var(--sb-text-xs);color:var(--sb-text-secondary);margin:0;white-space:pre-wrap;">{{ thesis_model.value_signal | tojson(indent=2) }}</pre>
          {% else %}
          <span style="color:var(--sb-text-muted);font-size:var(--sb-text-sm);">Not available</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}

{% else %}
  <div class="sb-thesis" style="text-align:center;padding:var(--sb-space-12);">
    <div class="sb-thesis__header" style="justify-content:center;">
      <h2 class="sb-thesis__title">No Thesis Today</h2>
      <span class="sb-thesis__gate sb-thesis__gate--fail">Gate Not Met</span>
    </div>
    <p class="sb-thesis__text" style="max-width:480px;margin:var(--sb-space-4) auto 0;">
      The momentum and value gate conditions were not met today.
      A thesis is generated when at least 2 of 3 US indices are up &gt;0.3% and gold is up &lt;2%.
    </p>
  </div>
{% endif %}

<!-- Stock Fundamentals (Grok-powered) -->
{% set fundamentals = thesis_section.content.get('stock_fundamentals', []) if thesis_section and thesis_section.get('content') else [] %}
{% if fundamentals %}
<section class="sb-section" style="margin-top:var(--sb-space-6);">
  <h2 class="sb-section__title">
    Stock Fundamentals
    <span class="sb-section__badge">{{ fundamentals | length }} tickers</span>
    <span class="sb-grok-take__badge" style="font-size:10px;color:var(--sb-text-muted);text-transform:uppercase;letter-spacing:0.08em;margin-left:var(--sb-space-2);">via Grok</span>
  </h2>

  <div class="sb-fundamentals-grid">
    {% for stock in fundamentals %}
    <div class="sb-fundamental-card">
      <div class="sb-fundamental-card__header" onclick="this.parentElement.classList.toggle('sb-fundamental-card--expanded')">
        <div class="sb-fundamental-card__ticker">{{ stock.ticker }}</div>
        <div class="sb-fundamental-card__company">{{ stock.company }}</div>
        <div class="sb-fundamental-card__metrics">
          {% if stock.current_price %}
          <span class="sb-fundamental-metric">${{ "%.2f" | format(stock.current_price) }}</span>
          {% endif %}
          {% if stock.pe_ratio %}
          <span class="sb-fundamental-metric" title="P/E Ratio">PE {{ "%.1f" | format(stock.pe_ratio) }}</span>
          {% endif %}
          {% if stock.eps_ttm %}
          <span class="sb-fundamental-metric" title="EPS (TTM)">EPS ${{ "%.2f" | format(stock.eps_ttm) }}</span>
          {% endif %}
          {% if stock.roce_pct %}
          <span class="sb-fundamental-metric" title="Return on Capital Employed">ROCE {{ "%.1f" | format(stock.roce_pct) }}%</span>
          {% endif %}
        </div>
        <svg class="sb-hf-card__chevron" width="14" height="14" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="6 9 12 15 18 9"></polyline>
        </svg>
      </div>

      <div class="sb-fundamental-card__body">
        {% if stock.quarterly_summary %}
        <div class="sb-fundamental-row">
          <span class="sb-fundamental-row__label">Quarterly</span>
          <span>{{ stock.quarterly_summary }}</span>
        </div>
        {% endif %}
        {% if stock.revenue_trend %}
        <div class="sb-fundamental-row">
          <span class="sb-fundamental-row__label">Revenue</span>
          <span>{{ stock.revenue_trend }}</span>
        </div>
        {% endif %}
        {% if stock.focus_areas %}
        <div class="sb-fundamental-row">
          <span class="sb-fundamental-row__label">Focus</span>
          <span>{{ stock.focus_areas | join(', ') }}</span>
        </div>
        {% endif %}

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:var(--sb-space-3);margin-top:var(--sb-space-3);">
          {% if stock.bull_case %}
          <div class="sb-fundamental-case sb-fundamental-case--bull">
            <div class="sb-fundamental-case__title">Bull Case</div>
            {% if stock.bull_case is string %}
              <p>{{ stock.bull_case }}</p>
            {% else %}
              <ul>
              {% for reason in stock.bull_case %}
                <li>{{ reason }}</li>
              {% endfor %}
              </ul>
            {% endif %}
          </div>
          {% endif %}
          {% if stock.bear_case %}
          <div class="sb-fundamental-case sb-fundamental-case--bear">
            <div class="sb-fundamental-case__title">Bear Case</div>
            {% if stock.bear_case is string %}
              <p>{{ stock.bear_case }}</p>
            {% else %}
              <ul>
              {% for reason in stock.bear_case %}
                <li>{{ reason }}</li>
              {% endfor %}
              </ul>
            {% endif %}
          </div>
          {% endif %}
        </div>

        {% if stock.sources %}
        <div style="margin-top:var(--sb-space-2);font-size:var(--sb-text-xs);color:var(--sb-text-muted);">
          Sources: {{ stock.sources | join(', ') }}
        </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- AI Analyst Signals (from hedge fund analysis) -->
{% if hf_signals %}
<div class="sb-hf-section" style="margin-top:var(--sb-space-8);">
  <h2 class="sb-section__title">
    AI Analyst Signals
    <span class="sb-section__badge">{{ hf_signals | length }} tickers</span>
  </h2>

  <!-- Consensus overview pills -->
  <div class="sb-hf-overview">
    {% for sig in hf_signals %}
    <div class="sb-hf-pill sb-hf-pill--{{ sig.consensus or sig.consensus_signal or 'neutral' }}">
      <span class="sb-hf-pill__ticker">{{ sig.ticker }}</span>
      <span class="sb-hf-pill__signal">{{ (sig.consensus or sig.consensus_signal or 'neutral') | title }}</span>
      <span class="sb-hf-pill__conf">{{ (sig.confidence or sig.consensus_confidence or 0) | round(0) | int }}%</span>
    </div>
    {% endfor %}
  </div>

  <!-- Per-ticker expandable cards -->
  {% for sig in hf_signals %}
  {% set signal_key = sig.consensus or sig.consensus_signal or 'neutral' %}
  <div class="sb-hf-card">
    <div class="sb-hf-card__header" onclick="this.parentElement.classList.toggle('sb-hf-card--expanded')">
      <div class="sb-hf-card__ticker">{{ sig.ticker }}</div>
      <div class="sb-hf-card__consensus sb-hf-signal--{{ signal_key }}">
        {{ signal_key | title }}
      </div>
      <div class="sb-hf-card__confidence">
        <div class="sb-hf-conf-bar">
          <div class="sb-hf-conf-bar__fill sb-hf-signal-bg--{{ signal_key }}"
               style="width:{{ (sig.confidence or sig.consensus_confidence or 0) }}%"></div>
        </div>
        <span>{{ (sig.confidence or sig.consensus_confidence or 0) | round(0) | int }}%</span>
      </div>
      <svg class="sb-hf-card__chevron" width="14" height="14" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </div>

    <div class="sb-hf-card__body">
      {% set analysts = sig.analysts or sig.analyst_signals or {} %}
      {% if analysts %}
        {% for agent_name, agent_data in analysts.items() %}
        {% if agent_data is mapping %}
        <div class="sb-hf-analyst-row">
          <div class="sb-hf-analyst-row__name">{{ agent_name | replace('_', ' ') | title }}</div>
          <div class="sb-hf-analyst-row__signal sb-hf-signal--{{ (agent_data.signal or 'neutral') | lower }}">
            {{ (agent_data.signal or 'N/A') | title }}
          </div>
          <div class="sb-hf-analyst-row__conf">{{ agent_data.confidence or 0 }}%</div>
          {% if agent_data.reasoning %}
          <div class="sb-hf-analyst-row__reasoning">
            {{ agent_data.reasoning | format_hf_reasoning(agent_name) }}
          </div>
          {% endif %}
        </div>
        {% endif %}
        {% endfor %}
      {% else %}
        <p style="color:var(--sb-text-muted);font-size:var(--sb-text-sm);padding:var(--sb-space-3) 0;">
          No analyst detail available for this ticker.
        </p>
      {% endif %}

      {% if sig.decision %}
      <div class="sb-hf-decision">
        <span class="sb-hf-decision__label">Portfolio Decision:</span>
        <span class="sb-hf-signal--{{ (sig.decision.action or 'hold') | lower }}">
          {{ (sig.decision.action or 'hold') | upper }}
        </span>
        {% if sig.decision.reasoning %}
        <span class="sb-hf-decision__reasoning">{{ sig.decision.reasoning | truncate(150) }}</span>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endfor %}

  <p class="sb-hf-disclaimer">
    AI-generated signals for educational purposes only. Not financial advice.
  </p>
</div>
{% endif %}
{% endblock %}
