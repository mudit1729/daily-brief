{% extends "base.html" %}
{% block title %}Pulse â€” {{ brief.date.strftime('%B %d, %Y') if brief else 'Today' }}{% endblock %}

{% block content %}
{% if not brief %}
  {% include "partials/empty_state.html" %}
{% else %}

  <!-- Brief header -->
  <div class="sb-brief-header">
    <div style="display:flex;align-items:center;gap:var(--sb-space-3);">
      <h1 class="sb-brief-header__date">{{ brief.date.strftime('%A, %B %d') }}</h1>
      <div class="sb-time-travel">
        <button class="sb-time-travel__btn" data-time-travel-toggle title="Go back in time">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <span>&raquo;</span>
        </button>
      </div>
    </div>
    <div class="sb-brief-header__clocks">
      <span class="sb-clock" data-tz="America/Los_Angeles" data-label="SD"></span>
      <span class="sb-clock" data-tz="Asia/Kolkata" data-label="HYD"></span>
    </div>
    <div class="sb-brief-header__meta">
      <span>{{ brief.date.strftime('%Y') }}</span>
      {% if overview %}
      <span>{{ overview.total_clusters }} Stories</span>
      <span>{{ overview.total_sources }} Sources</span>
      <span>{{ overview.section_count }} Sections</span>
      {% endif %}
    </div>
    <!-- Time travel wheel -->
    <div class="sb-time-travel__panel" data-time-travel-panel>
      <div class="sb-time-travel__wheel-row">
        <div class="sb-time-travel__wheel-wrapper">
          <div class="sb-time-travel__center-mark"></div>
          <div class="sb-time-travel__wheel" data-time-travel-wheel
               data-base-date="{{ today_date.isoformat() }}"></div>
        </div>
        <button class="sb-time-travel__go" data-time-travel-go>Go</button>
        <button class="sb-time-travel__close" data-time-travel-toggle>&times;</button>
      </div>
    </div>
  </div>

  <!-- Top strip: Weather + Market -->
  <div class="sb-top-strip">
    {% set weather = sections.get('weather', {}).get('content', {}) %}
    {% include "partials/weather_card.html" %}

    {% set market = sections.get('market', {}).get('content', {}) %}
    {% include "partials/market_mini.html" %}
  </div>

  <!-- Section nav -->
  {% include "partials/section_nav.html" %}

  <!-- News sections -->
  {% for section_key in news_sections %}
    {% set sec = sections.get(section_key) %}
    {% if sec and sec.content.get('clusters') %}
    <section id="section-{{ section_key }}" class="sb-section">
      <div class="sb-section__header">
        <h2 class="sb-section__title">
          {{ sec.title }}
          <span class="sb-section__badge">{{ sec.content.clusters | length }}</span>
          {% if sec.degradation and sec.degradation > 0 %}
          <span class="sb-badge sb-badge--warning" title="Degradation level {{ sec.degradation }}: budget constrained">D{{ sec.degradation }}</span>
          {% endif %}
        </h2>
        <div class="sb-stack-controls">
          <span class="sb-stack-counter">
            <span class="sb-stack-counter__current">1</span>/<span class="sb-stack-counter__total">{{ sec.content.clusters | length }}</span>
          </span>
          <button class="sb-stack-btn sb-stack-btn--prev" aria-label="Previous card" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <button class="sb-stack-btn sb-stack-btn--next" aria-label="Next card">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <button class="sb-stack-btn sb-stack-btn--reset" aria-label="Reset to first card" title="Back to first">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
          </button>
        </div>
      </div>

      <div class="sb-card-stack" data-current="0">
        {% for cluster in sec.content.clusters %}
          <div class="sb-card-stack__item {% if loop.index0 == 0 %}is-active{% elif loop.index0 <= 2 %}is-queued{% else %}is-hidden{% endif %}"
               data-stack-index="{{ loop.index0 }}"
               style="--stack-offset: {{ loop.index0 }}">
            {% include "partials/cluster_card.html" %}
          </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  {% endfor %}

  <!-- Investment thesis -->
  {% set thesis_content = sections.get('investment_thesis', {}).get('content', {}) %}
  {% if thesis_content %}
    {% set thesis = thesis_content %}
    {% include "partials/thesis_card.html" %}
  {% endif %}

{% endif %}
{% endblock %}
