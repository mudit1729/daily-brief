{% extends "base.html" %}
{% block title %}Pulse â€” Market{% endblock %}

{% block content %}
<div class="sb-brief-header">
  <h1 class="sb-brief-header__date">Market Overview</h1>
  <div class="sb-brief-header__meta">
    <span>{{ today_date.strftime('%B %d, %Y') }}</span>
  </div>
</div>

{% if market and market.get('content') %}
  {% set data = market.content %}

  <!-- Market performance table -->
  {% if data.get('market_data') %}
  <div class="sb-market-table-wrap">
    <table class="sb-market-table">
      <thead>
        <tr>
          <th class="sb-market-table__name-col">Asset</th>
          <th class="sb-market-table__price-col">Price</th>
          <th class="sb-market-table__change-col">1 Day</th>
          <th class="sb-market-table__change-col">1 Month</th>
          <th class="sb-market-table__change-col">3 Months</th>
          <th class="sb-market-table__change-col">1 Year</th>
        </tr>
      </thead>
      <tbody>
        {% for item in data.market_data %}
        <tr class="sb-market-table__row">
          <td class="sb-market-table__name">
            <span class="sb-market-table__symbol-icon">{{ item.get('name', '')[0] if item.get('name') else '?' }}</span>
            {{ item.get('name', item.get('symbol', '')) }}
          </td>
          <td class="sb-market-table__price">
            {% if item.price %}{{ "{:,.2f}".format(item.price) }}{% else %}--{% endif %}
          </td>
          <td class="sb-market-table__change">
            {% set d = item.change_pct or 0 %}
            <div class="sb-perf-cell sb-perf-cell--{{ 'positive' if d > 0 else ('negative' if d < 0 else 'neutral') }}">
              <span class="sb-perf-cell__value">{{ d | change_sign }}</span>
              <div class="sb-perf-bar-track">
                <div class="sb-perf-bar sb-perf-bar--{{ 'positive' if d > 0 else ('negative' if d < 0 else 'neutral') }}"
                     style="width:{{ [([d|abs, 0.1]|max), 20]|min / 20 * 100 }}%"></div>
              </div>
            </div>
          </td>
          <td class="sb-market-table__change">
            {% set m = item.change_1m_pct if item.change_1m_pct is defined else 0 %}
            <div class="sb-perf-cell sb-perf-cell--{{ 'positive' if m > 0 else ('negative' if m < 0 else 'neutral') }}">
              <span class="sb-perf-cell__value">{{ m | change_sign }}</span>
              <div class="sb-perf-bar-track">
                <div class="sb-perf-bar sb-perf-bar--{{ 'positive' if m > 0 else ('negative' if m < 0 else 'neutral') }}"
                     style="width:{{ [([m|abs, 0.1]|max), 30]|min / 30 * 100 }}%"></div>
              </div>
            </div>
          </td>
          <td class="sb-market-table__change">
            {% set q = item.change_3m_pct if item.change_3m_pct is defined else 0 %}
            <div class="sb-perf-cell sb-perf-cell--{{ 'positive' if q > 0 else ('negative' if q < 0 else 'neutral') }}">
              <span class="sb-perf-cell__value">{{ q | change_sign }}</span>
              <div class="sb-perf-bar-track">
                <div class="sb-perf-bar sb-perf-bar--{{ 'positive' if q > 0 else ('negative' if q < 0 else 'neutral') }}"
                     style="width:{{ [([q|abs, 0.1]|max), 50]|min / 50 * 100 }}%"></div>
              </div>
            </div>
          </td>
          <td class="sb-market-table__change">
            {% set y = item.change_1y_pct if item.change_1y_pct is defined else 0 %}
            <div class="sb-perf-cell sb-perf-cell--{{ 'positive' if y > 0 else ('negative' if y < 0 else 'neutral') }}">
              <span class="sb-perf-cell__value">{{ y | change_sign }}</span>
              <div class="sb-perf-bar-track">
                <div class="sb-perf-bar sb-perf-bar--{{ 'positive' if y > 0 else ('negative' if y < 0 else 'neutral') }}"
                     style="width:{{ [([y|abs, 0.1]|max), 80]|min / 80 * 100 }}%"></div>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}

  <!-- Market news clusters -->
  {% if data.get('clusters') %}
  <section class="sb-section">
    <h2 class="sb-section__title">
      Top Drivers
      <span class="sb-section__badge">{{ data.clusters | length }}</span>
    </h2>
    {% for cluster in data.clusters %}
      {% include "partials/cluster_card.html" %}
    {% endfor %}
  </section>
  {% endif %}

{% else %}
  {% set empty_title = 'No market data' %}
  {% set empty_text = 'Market data will be available after the next pipeline run during market hours.' %}
  {% include "partials/empty_state.html" %}
{% endif %}
{% endblock %}
