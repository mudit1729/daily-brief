{% extends "base.html" %}
{% block title %}Signal Brief â€” {{ brief.date.strftime('%B %d, %Y') if brief else 'Today' }}{% endblock %}

{% block content %}
{% if not brief %}
  {% include "partials/empty_state.html" %}
{% else %}

  <!-- Brief header -->
  <div class="sb-brief-header">
    <h1 class="sb-brief-header__date">{{ brief.date.strftime('%A, %B %d') }}</h1>
    <div class="sb-brief-header__meta">
      <span>{{ brief.date.strftime('%Y') }}</span>
      <span>{{ brief.sections | length }} sections</span>
      {% if brief.total_tokens %}
      <span>{{ brief.total_tokens | int }} tokens</span>
      {% endif %}
      {% if brief.total_cost_usd %}
      <span>${{ "%.4f" | format(brief.total_cost_usd) }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Overview tile -->
  {% if overview %}
  <div class="sb-overview">
    <div class="sb-overview__stats">
      <div class="sb-overview__stat">
        <div class="sb-overview__stat-value">{{ overview.total_clusters }}</div>
        <div class="sb-overview__stat-label">Stories</div>
      </div>
      <div class="sb-overview__stat">
        <div class="sb-overview__stat-value">{{ overview.total_sources }}</div>
        <div class="sb-overview__stat-label">Sources</div>
      </div>
      <div class="sb-overview__stat">
        <div class="sb-overview__stat-value">{{ overview.section_count }}</div>
        <div class="sb-overview__stat-label">Sections</div>
      </div>
    </div>
    <div class="sb-overview__highlights">
      {% for story in overview.top_stories %}
      <div class="sb-overview__highlight">
        <span class="sb-overview__highlight-dot" style="background:var(--sb-accent);"></span>
        <span class="sb-truncate-1" style="flex:1;">{{ story.label }}</span>
      </div>
      {% endfor %}
      {% if overview.market_highlight %}
      <div class="sb-overview__highlight">
        <span class="sb-overview__highlight-dot" style="background:var(--sb-{{ overview.market_highlight.change_pct | change_class }});"></span>
        <span>{{ overview.market_highlight.name }} {{ overview.market_highlight.change_pct | change_sign }}</span>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Top strip: Weather + Market -->
  <div class="sb-top-strip">
    {% set weather = sections.get('weather', {}).get('content', {}) %}
    {% include "partials/weather_card.html" %}

    {% set market = sections.get('market', {}).get('content', {}) %}
    {% include "partials/market_mini.html" %}
  </div>

  <!-- Section nav -->
  {% include "partials/section_nav.html" %}

  <!-- News sections -->
  {% for section_key in news_sections %}
    {% set sec = sections.get(section_key) %}
    {% if sec and sec.content.get('clusters') %}
    <section id="section-{{ section_key }}" class="sb-section">
      <div class="sb-section__header">
        <h2 class="sb-section__title">
          {{ sec.title }}
          <span class="sb-section__badge">{{ sec.content.clusters | length }}</span>
          {% if sec.degradation and sec.degradation > 0 %}
          <span class="sb-badge sb-badge--warning" title="Degradation level {{ sec.degradation }}: budget constrained">D{{ sec.degradation }}</span>
          {% endif %}
        </h2>
        <div class="sb-stack-controls">
          <span class="sb-stack-counter">
            <span class="sb-stack-counter__current">1</span>/<span class="sb-stack-counter__total">{{ sec.content.clusters | length }}</span>
          </span>
          <button class="sb-stack-btn sb-stack-btn--prev" aria-label="Previous card" disabled>
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <button class="sb-stack-btn sb-stack-btn--next" aria-label="Next card">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
          <button class="sb-stack-btn sb-stack-btn--reset" aria-label="Reset to first card" title="Back to first">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
          </button>
        </div>
      </div>

      <div class="sb-card-stack" data-current="0">
        {% for cluster in sec.content.clusters %}
          <div class="sb-card-stack__item {% if loop.index0 == 0 %}is-active{% elif loop.index0 <= 2 %}is-queued{% else %}is-hidden{% endif %}"
               data-stack-index="{{ loop.index0 }}"
               style="--stack-offset: {{ loop.index0 }}">
            {% include "partials/cluster_card.html" %}
          </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  {% endfor %}

  <!-- Investment thesis -->
  {% set thesis_content = sections.get('investment_thesis', {}).get('content', {}) %}
  {% if thesis_content %}
    {% set thesis = thesis_content %}
    {% include "partials/thesis_card.html" %}
  {% endif %}

{% endif %}
{% endblock %}
